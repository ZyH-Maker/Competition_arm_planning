<root BTCPP_format="4">
  <BehaviorTree ID="PlaceAndPick">
    <Sequence name="PlaceAndPick">

      <!-- 1) 视觉获取三个放置点，必须全部有效 -->
      <Action ID="RequestPlacePointsAllValid"
              points_out="{place_points}"/>
      <!-- <Script code="task_order_str := '1,2,3'"/> -->
      <!-- 调试：固定顺序 -->
      <Script code="place_order_work := task_order_str"/>
      <Script code="pick_order_work := task_order_str"/>

      <!-- 2) PLACE：从车上取块 -> 放到对应放置点 -> 转盘 -->
      <ForceSuccess>
        <Repeat num_cycles="-1" name="Loop_Place_Three">
          <Sequence name="Place_One">

            <Action ID="PopAndSelectPlaceTarget"
                    order_in="{place_order_work}"
                    order_out="{place_order_work}"
                    points_in="{place_points}"
                    target_out="{place_target}"
                    target_id="{target_id}"
                    object_id="{place_object_id}"/>

            <!-- 动态生成车上固定点圆柱体（ID=任务码） -->
            <Action ID="AddCollisionCylinders"
                    target_id="{target_id}"
                    fix_pose="{fix_pose}"
                    cylinder_out="{onboard_cylinder}"
                    object_id_out="{onboard_object_id}"/>

            <!-- 从车上固定点抓取 -->
            <Action ID="ExecPresetTarget"/>
            <Action ID="CloseGripper"/>
            <Action ID="AttachObject" object_id="{onboard_object_id}"/>
            <Action ID="ExecPresetHome"/>

            <!-- 放置到目标点 -->
            <Action ID="PlanWithFallback"
                    target_in="{place_target}"/>
            <Action ID="OpenGripper"/>
            <Action ID="DetachObject" object_id="{onboard_object_id}"/>
            <Action ID="GoHome"/>
            <Action ID="RotateTurntable"/>

          </Sequence>
        </Repeat>
      </ForceSuccess>

      <!-- 3) PICK：按任务码顺序把三块从放置点抓回车上固定点 -->
      <ForceSuccess>
        <Repeat num_cycles="-1" name="Loop_Pick_Three">
          <Sequence name="Pick_One">

            <Action ID="PopAndSelectPlaceTarget"
                    order_in="{pick_order_work}"
                    order_out="{pick_order_work}"
                    points_in="{place_points}"
                    target_out="{place_target}"
                    target_id="{target_id}"
                    object_id="{place_object_id}"/>

            <!-- 从放置点抓取 -->
            <Action ID="PlanWithFallback"
                    target_in="{place_target}"/>
            <Action ID="CloseGripper"/>
            <Action ID="AttachObject" object_id="{place_object_id}"/>

            <!-- 放回车上固定点（不生成车上障碍物） -->
            <Action ID="PlanWithFallback"
                    target_in="{onboard_target}"/>
            <Action ID="OpenGripper"/>
            <Action ID="DetachObject" object_id="{place_object_id}"/>

            <!-- 每次取回后：先回 HOME 再转盘 -->
            <Action ID="GoHome"/>
            <Action ID="RotateTurntable"/>
            <!-- 删除已放回车上的物体，避免成为障碍物 -->
            <Action ID="RemoveCollisionObject"
                    cylinder_in="{place_target}"/>

          </Sequence>
        </Repeat>
      </ForceSuccess>

    </Sequence>
  </BehaviorTree>
</root>
